---
title: "ClinEpi Metrics"
output: html_document
---

```{r setup, include=FALSE, echo=TRUE}
library(knitr)
library(tidyverse)
library(kableExtra)
library(rio)
library(ggplot2)
library(scales)
library(RColorBrewer)


integer_breaks <- function(n = 5, ...) {
  fxn <- function(x) {
    breaks <- floor(pretty(x, n, ...))
    names(breaks) <- attr(breaks, "labels")
    breaks
  }
  return(fxn)
}


#set colors
powderblue <- "#c6dfe3"
teal <- "#0d5970"
pink <- "#f0c1c6"
lavender <- "#e8e8e8"
darkorange <- "#fe6d0e"
darkturquoise <- "#05adda"
yellowgreen <- "#7cc044"
gainsboro <- "e2e2e2"

allColors <- c(teal, powderblue, pink, darkorange, darkturquoise, yellowgreen)

createdColors <- c("#0D5970", "#3381C1", "#F94E56", "#FB898D", "#F6C865", lavender)


globalUsage <-import("data/globalUsage.csv")
googleScholarCitations <-import("data/googleScholarCitations.csv")
studyMetrics <-import("data/studyMetrics.csv")
websiteUsage <-import("data/websiteUsage_awstats.csv")


today <- Sys.Date()
todayFormated <- format(today, format="%Y-%m-%d")
```


##Plot usage of ClinEpiDB around the world
```{r globalUsage}
#flip data

globalUsageForPlot <- pivot_longer(globalUsage,!Year, names_to = "region", values_to = "count")


globalUsagePlot <- ggplot(globalUsageForPlot, aes(x=Year, y=count, fill=region)) +
geom_bar(stat="identity") +
    scale_fill_brewer(palette = "Dark2") + 
    theme_bw() + 
    theme(panel.border = element_blank(), panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),    text=element_text(family="sans"), plot.title = element_text(hjust = 0.5, size = 16,face="bold")) + 
    labs(fill = "Continent") + 
    ylab("Users per region")+
    ggtitle ("ClinEpiDB global usage (Google Analytics)") 

globalUsagePlot  

ggsave(paste0("plots/globalUsagePlot","_", todayFormated,".png", sep = ""), plot = globalUsagePlot)

```

##Plot the number of citiations of ClinEpiDB per year
```{r googleScholarCitations}
citations <- ggplot(googleScholarCitations, aes(x=year, y=citations)) +
  geom_area(fill="powderblue", alpha=.4) + 
  geom_line(color = teal)+
  theme_bw() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),    text=element_text(family="sans"), plot.title = element_text(hjust = 0.5, size = 16,face="bold")) + 
    xlab("Year") +
    ylab("Citations")+
    ggtitle ("ClinEpiDB citations per year")

citations

ggsave(paste0("plots/citations", "_", todayFormated,".png", sep = ""), plot = citations)
```

##Plot the cumulative number of citiations of ClinEpiDB
```{r googleScholarCitations Cum}
cumlative <- ggplot(googleScholarCitations, aes(x=year, y=cumulativeCitations)) +
  geom_area(fill="powderblue", alpha=.4) + 
  geom_line(color = teal)+
  theme_bw() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),    text=element_text(family="sans"), plot.title = element_text(hjust = 0.5, size = 16,face="bold")) + 
    xlab("Year") +
    ylab("Cumulative citations")+
    ggtitle ("ClinEpiDB cumulative citations")

cumlative

ggsave(paste0("plots/cumlativeCitations", "_", todayFormated,".png", sep = ""), plot = cumlative)
```

##Plot the number of unique visitors ClinEpiDB received on average per month each year. Data from AW stats
```{r websiteUsagevisitors}

uniqueVisitors <- ggplot(websiteUsage, aes(x=Year, y=UniqueVisitorsPerMonth)) +
  geom_line(color = teal)+ geom_point() + 
  scale_x_continuous(breaks = integer_breaks())+
  theme_bw() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),    text=element_text(family="sans"), plot.title = element_text(hjust = 0.5, size = 16,face="bold")) + 
    xlab("Year") +
    ylab("Unique visitors/month") +
    ggtitle ("ClinEpiDB unique visitors per month (AW Stats)")
   

uniqueVisitors

ggsave(paste0("plots/uniqueVisitors", "_", todayFormated,".png", sep = ""), plot = uniqueVisitors)
```

##Plot the number of visits ClinEpiDB received on average per month each year. Data from AW stats
```{r r websiteUsagevisits}

visits <- ggplot(websiteUsage, aes(x=Year, y=NumberOfVisitsPerMonth)) +
  geom_line(color = teal)+ geom_point() + 
  scale_x_continuous(breaks = integer_breaks())+
  theme_bw() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),    text=element_text(family="sans"), plot.title = element_text(hjust = 0.5, size = 16,face="bold")) + 
    xlab("Year") +
    ylab("Visits/month") +
    ggtitle ("ClinEpiDB visits per month (AW Stats)")

visits

ggsave(paste0("plots/visits", "_", todayFormated,".png", sep = ""), plot = visits)
```

##Plot the number of records per project
```{r studyMetricsByProject}

studyMetricsReleasedSubset <- subset(studyMetrics, released == "yes")

studyMetricsByProjectSelect <- select(studyMetricsReleasedSubset, c("project", "household","participants","observations", "samples" ))

studyMetricsByProjectLong <- pivot_longer(studyMetricsByProjectSelect, !project, names_to = "typeOfCount", values_to = "count")

studyMetricsByProject<- studyMetricsByProjectLong  %>% 
  group_by(project, typeOfCount) %>%                       
  summarise_at(vars(count),              
               list(count = sum))



studyMetricsByProjectPlot <- ggplot(studyMetricsByProject, aes(x=typeOfCount, y=count, fill=project)) +
            geom_bar(stat="identity")+
            scale_y_continuous(labels = comma)+
            scale_fill_brewer(palette = "Set2") + 
            theme_bw() +
            theme(panel.border = element_blank(), 
                panel.grid.major = element_blank(),
                panel.grid.minor = element_blank(),
                axis.line = element_line(colour = "black"),    
                text=element_text(family="sans"),
                plot.title = element_text(hjust = 0.5, size = 16,face="bold"), 
                legend.title = element_blank(), 
                legend.text = element_text(size = 5), 
                legend.key.size = unit(5, 'mm')) + 
                xlab("") +
                ylab("Count")+
                ggtitle("Records by project")
  

horizontalMetricsByProject <- studyMetricsByProjectPlot + coord_flip()
horizontalMetricsByProject

ggsave(paste0("plots/studyMetricsByProjectPlot", "_", todayFormated,".png", sep = ""), plot = horizontalMetricsByProject)

```

##Plot the number of records per disease
```{r studyMetricsByDisease}

studyMetricsByDiseaseSelect <- select(studyMetricsReleasedSubset, c("disease", "household","participants","observations", "samples" ))


studyMetricsByDiseaseLong <- pivot_longer(studyMetricsByDiseaseSelect, !disease, names_to = "typeOfCount", values_to = "count")

studyMetricsByDisease<- studyMetricsByDiseaseLong  %>% 
  group_by(disease, typeOfCount) %>%                       
  summarise_at(vars(count),              
               list(count = sum))



studyMetricsByDiseasePlot <- ggplot(studyMetricsByDisease, aes(x=typeOfCount, y=count, fill=disease)) +
            geom_bar(stat="identity")+
            scale_y_continuous(labels = comma)+
            scale_fill_brewer(palette = "Set2") + 
            theme_bw() +
            theme(panel.border = element_blank(), 
                panel.grid.major = element_blank(),
                panel.grid.minor = element_blank(),
                axis.line = element_line(colour = "black"),    
                text=element_text(family="sans"),
                plot.title = element_text(hjust = 0.5, size = 16,face="bold"), 
                legend.title = element_blank(), 
                legend.text = element_text(size = 5), 
                legend.key.size = unit(5, 'mm')) + 
                xlab("") +
                ylab("Count")+
                ggtitle("Records by disease")
  

horizontalMetricsByDisease <- studyMetricsByDiseasePlot + coord_flip()


horizontalMetricsByDisease

ggsave(paste0("plots/studyMetricsByDiseasePlot", "_", todayFormated,".png", sep = ""), plot = horizontalMetricsByDisease)

```

