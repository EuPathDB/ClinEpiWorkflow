<workflowGraph name="">
  <param name="projectName"/>
  <param name="parentDataDir"/>
  <constant name="dataDir">${parentDataDir}/edaStudies</constant>

  <constant name="relativeWebServicesDir">webServices/$$projectName$$/release-$$projectVersionForWebsiteFiles$$</constant>
  <constant name="relativeDownloadSiteDir">downloadSite/$$projectName$$/release-$$projectVersionForWebsiteFiles$$/</constant>
  <constant name="relativeAuxiliaryDir">auxiliary/$$projectName$$/release-$$projectVersionForWebsiteFiles$$/</constant>

  <globalSubgraph name="clinepiGlobal" xmlFile="clinepiGlobal.xml">
    <paramValue name="globalDatasetLoaderXmlFile">clinepiGlobal.xml</paramValue>
    <paramValue name="projectName">$$projectName$$</paramValue>
  </globalSubgraph>
  <step name="makeProjectReleaseDownloadDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeDownloadSiteDir$$</paramValue>
    <dependsGlobal name="initUserGroupProject"/>
  </step>


  <step name="makeDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$dataDir$$</paramValue>
  </step>

  <datasetTemplate class="ISASimpleNF">
    <prop name="projectName"/>
    <prop name="subProjectName"/>
    <prop name="groupName"/>
    <prop name="studyName"/>
    <prop name="version"/>
    <prop name="webDisplayOntologyName"/>
    <prop name="nameForFilenames"/>

    <subgraph name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC" xmlFile="loadEdaStudy.xml">
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="datasetVersion">${version}</paramValue>
      <paramValue name="projectName">${projectName}</paramValue>
      <paramValue name="webDisplayOntologyName">${webDisplayOntologyName}</paramValue>
      <paramValue name="webDisplayOntologyFile">ontology/release/production/${webDisplayOntologyName}.owl</paramValue>
      <paramValue name="speciesReconciliationOntologySpec"></paramValue>
      <paramValue name="speciesReconciliationFallbackSpecies"></paramValue>
      <paramValue name="loadStudyCharacteristics">true</paramValue>
      <paramValue name="context">clinepi</paramValue>
      <paramValue name="optionalMegaStudyStableId"></paramValue>
      <paramValue name="studyClassificationsYaml">lib/yaml/ClinEpiDB.yaml</paramValue>
      <paramValue name="studyClassificationsOwl">ontology/release/production/classifications.owl</paramValue>
      <depends name="makeDataDir"/>
      <dependsGlobal name="Ontology_entityTypesAndProtocols_RSRC"/>
    </subgraph>
  
    <step name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_makeEntityDownloadFiles" 
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertEDA">
    	<paramValue name="plugin">ApiCommonData::Load::Plugin::MakeEntityDownloadFiles</paramValue>
      <paramValue name="extDbRlsSpec">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC|${version}</paramValue>
      <paramValue name="fileBasename">${groupName}_${studyName}</paramValue>
      <paramValue name="webDisplayOntologyName">${webDisplayOntologyName}</paramValue>
      <paramValue name="dataDir">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="outputDir"></paramValue>
    	<paramValue name="schema">EDA</paramValue>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC"/>
    </step>

    <step name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_copyEntityDownloadFiles" 
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyShinyFilesToDownloadDir">
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue> 
      <paramValue name="nameForFilenames">${nameForFilenames}</paramValue>
      <paramValue name="inputFileBaseName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="relativeDownloadSiteDir">$$relativeDownloadSiteDir$$</paramValue>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_makeEntityDownloadFiles"/>
      <depends name="makeProjectReleaseDownloadDir"/>
    </step>

    <step name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_manualDownloadFiles"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyDownloadFilesDirFromManualDelivery">
      <paramValue name="projectName">${projectName}</paramValue>
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="relativeManualDeliveryDir">${subProjectName}/${groupName}/${studyName}/${version}/final/downloadSiteFiles</paramValue>
      <paramValue name="relativeDownloadSiteDir">$$relativeDownloadSiteDir$$</paramValue>
      <depends name="makeProjectReleaseDownloadDir"/>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_copyEntityDownloadFiles"/>
    </step>
  </datasetTemplate>



</workflowGraph>
