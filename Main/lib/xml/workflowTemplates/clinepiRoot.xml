<workflowGraph name="">
  <param name="projectName"/>
  <param name="projectVersionForWebsiteFiles"/>
 

  <constant name="relativeWebServicesDir">webServices/$$projectName$$/release-$$projectVersionForWebsiteFiles$$</constant>
  <constant name="relativeDownloadSiteDir">downloadSite/$$projectName$$/release-$$projectVersionForWebsiteFiles$$/</constant>
  <constant name="relativeAuxiliaryDir">auxiliary/$$projectName$$/release-$$projectVersionForWebsiteFiles$$/</constant>


<!--  <constant name="globalDataDir">global</constant>-->

  <globalSubgraph name="clinepiGlobal" xmlFile="clinepiGlobal.xml">
    <paramValue name="globalDatasetLoaderXmlFile">clinepiGlobal.xml</paramValue>
    <paramValue name="projectName">$$projectName$$</paramValue>
  </globalSubgraph>
  

  <step name="makeProjectReleaseDownloadDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeDownloadSiteDir$$</paramValue>
    <dependsGlobal name="initUserGroupProject"/>
  </step>
  
  <step name="makeProjectReleaseWebServicesDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeWebServicesDir$$</paramValue>
    <dependsGlobal name="initUserGroupProject"/>
  </step>
  
  <step name="makeProjectReleaseAuxiliaryDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeAuxiliaryDir$$</paramValue>
    <dependsGlobal name="initUserGroupProject"/>
  </step>

  <datasetTemplate class="WebDisplayOntologyClinEpi">
    <prop name="name"/>
    <prop name="version"/>
    <prop name="projectName"/>

    <subgraph name="OntologyTerm_${name}_RSRC" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">OntologyTerm_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir"></paramValue>
      <dependsGlobal name="Ontology_Relationship_Types_RSRC"/>
    </subgraph>
  </datasetTemplate>


  <datasetTemplate class="UpdateWebDisplayOntologyClinEpi">
    <prop name="name"/>
    <prop name="version"/>
    <prop name="projectName"/>

    <subgraph name="OntologyTerm_UPDATE_${name}_RSRC" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">OntologyTerm_INTERNAL_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir"></paramValue>
      <depends name="OntologyTerm_${name}_RSRC"/>
    </subgraph>
  </datasetTemplate>

  <datasetTemplate class="ISASimpleClinEpi">
    <prop name="projectName"/>
    <prop name="subProjectName"/>
    <prop name="groupName"/>
    <prop name="studyName"/>
    <prop name="version"/>
    <prop name="webDisplayOntologyName"/>
    
    <subgraph name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir"></paramValue>
      <depends name="OntologyTerm_${webDisplayOntologyName}_RSRC"/>
      <dependsGlobal name="EuPath_Ontology_RSRC"/> <!-- use Update Eupath ontology class to avoid rerunning DONE ISASimple steps -->
    </subgraph>

    <step name="${subProjectName}_${groupName}_${studyName}_RSRC_tuning"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeDatasetSpecificDerivedTables" stepLoadTypes="tuningManager">
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="tables">SampleId,PANRecord,PANResults,PANIO,PANExtDbRls,InferredParams,PANParamValues,DefaultChars,Metadata,Ontology,Samples,PropertyType,ParticipantMD,ObservationMD,PartObsIdMD,HouseholdMD,HousePartIdMD,HouseObsIdMD</paramValue>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC"/>
      <depends name="OntologyTerm_${webDisplayOntologyName}_RSRC"/>
    </step>

    <step name="${subProjectName}_${groupName}_${studyName}_RSRC_shinyTables"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeClinEpiShinyDatasetFiles">
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="outputFileBaseName">shiny</paramValue>
      <depends name="${subProjectName}_${groupName}_${studyName}_RSRC_tuning"/>
    </step>

    <step name="${subProjectName}_${groupName}_${studyName}_RSRC_shinyWSFiles" 
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyShinyFilesToWebServices">
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="inputFileBaseName">shiny</paramValue>
      <paramValue name="relativeWebServicesDir">$$relativeWebServicesDir$$</paramValue>
      <depends name="${subProjectName}_${groupName}_${studyName}_RSRC_shinyTables"/>
      <depends name="makeProjectReleaseWebServicesDir"/>
    </step>
  </datasetTemplate>

</workflowGraph>

