<workflowGraph name="">
  <param name="projectName"/>
  <param name="projectVersionForWebsiteFiles"/>
 

  <constant name="relativeWebServicesDir">webServices/$$projectName$$/release-$$projectVersionForWebsiteFiles$$</constant>
  <constant name="relativeDownloadSiteDir">downloadSite/$$projectName$$/release-$$projectVersionForWebsiteFiles$$/</constant>
  <constant name="relativeAuxiliaryDir">auxiliary/$$projectName$$/release-$$projectVersionForWebsiteFiles$$/</constant>

<!--  <constant name="globalDataDir">global</constant>-->

  <globalSubgraph name="clinepiGlobal" xmlFile="clinepiGlobal.xml">
    <paramValue name="globalDatasetLoaderXmlFile">clinepiGlobal.xml</paramValue>
    <paramValue name="projectName">$$projectName$$</paramValue>
  </globalSubgraph>
  

  <step name="makeProjectReleaseDownloadDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeDownloadSiteDir$$</paramValue>
    <dependsGlobal name="initUserGroupProject"/>
  </step>
  
  <step name="makeProjectReleaseWebServicesDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeWebServicesDir$$</paramValue>
    <dependsGlobal name="initUserGroupProject"/>
  </step>
  
  <step name="makeProjectReleaseAuxiliaryDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeAuxiliaryDir$$</paramValue>
    <dependsGlobal name="initUserGroupProject"/>
  </step>


  <datasetTemplate class="genericProfilesClinEpi">
    <prop name="name"/>
    <prop name="version"/>
    <prop name="technologyType"/>
    <prop name="projectName"/>
    
    <subgraph name="${name}" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">Profile_${technologyType}_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir"></paramValue>
      <dependsGlobal name="initUserGroupProject"/>
    </subgraph>
    
    <subgraph name="${name}_analyze_${technologyType}_profile" xmlFile="analyzeGenericClinEpiProfileExperiment.xml">
      <paramValue name="parentDataDir"></paramValue>
      <paramValue name="experimentDatasetName">Profile_${technologyType}_${name}_RSRC</paramValue>
      <paramValue name="experimentDatasetVersion">${version}</paramValue>
      <paramValue name="hasTimeSeries">false</paramValue>
      <paramValue name="organismAbbrev"></paramValue>
      <paramValue name="relativeDownloadSiteDir">$$relativeDownloadSiteDir$$</paramValue>
      <paramValue name="studyName">${technologyType} Study ${name}</paramValue>
      <paramValue name="technologyType">${technologyType}</paramValue>
      <depends name="${name}"/>
      <depends name="makeProjectReleaseDownloadDir"/>
    </subgraph>
  </datasetTemplate>


  <datasetTemplate class="WebDisplayOntologyEDA">
    <prop name="name"/>
    <prop name="version"/>
    <prop name="projectName"/>

    <subgraph name="OntologyTerm_${name}_RSRC" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">OntologyTerm_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir"></paramValue>
    <paramValue name="conversionFile">${conversionFile}</paramValue>
    <paramValue name="baseOwl">${baseOwl}</paramValue>
      <dependsGlobal name="Ontology_entityTypesAndProtocols_RSRC"/>
    </subgraph>
  </datasetTemplate>



  <datasetTemplate class="WebDisplayOntologyClinEpi">
    <prop name="name"/>
    <prop name="version"/>
    <prop name="projectName"/>

    <subgraph name="OntologyTerm_${name}_RSRC" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">OntologyTerm_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir"></paramValue>
      <dependsGlobal name="Ontology_entityTypesAndProtocols_RSRC"/>
    </subgraph>
  </datasetTemplate>

  <datasetTemplate class="UpdateWebDisplayOntologyClinEpi">
    <prop name="name"/>
    <prop name="version"/>
    <prop name="projectName"/>

    <subgraph name="OntologyTerm_UPDATE_${name}_RSRC" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">OntologyTerm_INTERNAL_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir"></paramValue>
      <depends name="OntologyTerm_${name}_RSRC"/>
    </subgraph>
  </datasetTemplate>

  <datasetTemplate class="ISASimpleClinEpi">
    <prop name="projectName"/>
    <prop name="subProjectName"/>
    <prop name="groupName"/>
    <prop name="studyName"/>
    <prop name="version"/>
    <prop name="webDisplayOntologyName"/>
    <prop name="nameForFilenames"/>
    
    <subgraph name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir"></paramValue>
      <depends name="OntologyTerm_${webDisplayOntologyName}_RSRC"/>
<!-- EDA TODO add dependency Ontology_entityTypesAndProtocols_RSRC -->
      <dependsGlobal name="Ontology_entityTypesAndProtocols_RSRC"/> <!-- use Update Eupath ontology class to avoid rerunning DONE ISASimple steps -->
<!--
      <dependsGlobal name="EuPath_Ontology_RSRC"/> 
-->
    </subgraph>

<!-- Add column values to SRes.OntologySynonym plural, permutation, flags -->

    <step name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_updateOntologySynonym_entities" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::UpdateOntologySynonym" stepLoadTypes="plugin">
    	<paramValue name="plugin">GUS::Supported::Plugin::InsertOntologySynonymAttributes</paramValue>
      <paramValue name="webDisplayOntologyName">${webDisplayOntologyName}</paramValue>
      <paramValue name="attributesFile">entities.txt</paramValue>
      <paramValue name="dataDir">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC/final</paramValue>
      <paramValue name="enableUndo">0</paramValue>
      <depends name="OntologyTerm_${webDisplayOntologyName}_RSRC"/>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC"/>
    </step>
    <step name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_updateOntologySynonym_ordinals" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::UpdateOntologySynonym" stepLoadTypes="plugin">
    	<paramValue name="plugin">GUS::Supported::Plugin::InsertOntologySynonymAttributes</paramValue>
      <paramValue name="webDisplayOntologyName">${webDisplayOntologyName}</paramValue>
      <paramValue name="attributesFile">ordinals.txt</paramValue>
      <paramValue name="dataDir">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC/final</paramValue>
      <paramValue name="enableUndo">0</paramValue>
      <depends name="OntologyTerm_${webDisplayOntologyName}_RSRC"/>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC"/>
    </step>
    <step name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_updateOntologySynonym_owlAttributes" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::UpdateOntologySynonym" stepLoadTypes="plugin">
    	<paramValue name="plugin">GUS::Supported::Plugin::InsertOntologySynonymAttributes</paramValue>
      <paramValue name="webDisplayOntologyName">${webDisplayOntologyName}</paramValue>
      <paramValue name="attributesFile">owlAttributes.txt</paramValue>
      <paramValue name="dataDir">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC/final</paramValue>
      <paramValue name="enableUndo">0</paramValue>
      <depends name="OntologyTerm_${webDisplayOntologyName}_RSRC"/>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC"/>
    </step>

    <step name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_insertEntityGraph" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertEDA" stepLoadTypes="plugin">
    	<paramValue name="plugin">ApiCommonData::Load::Plugin::InsertEntityGraph</paramValue>
      <paramValue name="extDbRlsSpec">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC|${version}</paramValue>
      <paramValue name="dataDir">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC/final</paramValue>
      <paramValue name="webDisplayOntologyName">${webDisplayOntologyName}</paramValue>
    	<paramValue name="dateObfuscationFile">dateObfuscation.txt</paramValue>
    	<paramValue name="investigationBaseName">investigation.xml</paramValue>
    	<paramValue name="isSimpleConfiguration">1</paramValue>
    	<paramValue name="ontologyMappingOverrideFileBaseName">ontologyMapping.xml</paramValue>
    	<paramValue name="valueMappingFile">valueMap.txt</paramValue>
    	<paramValue name="schema">EDA</paramValue>
      <depends name="OntologyTerm_${webDisplayOntologyName}_RSRC"/>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC"/>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_updateOntologySynonym_entities"/>
    </step>

    <step name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_loadAttributesFromEntityGraph" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertEDA" stepLoadTypes="plugin">
    	<paramValue name="plugin">ApiCommonData::Load::Plugin::LoadAttributesFromEntityGraph</paramValue>
      <paramValue name="extDbRlsSpec">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC|${version}</paramValue>
      <paramValue name="webDisplayOntologyName">${webDisplayOntologyName}</paramValue>
    	<paramValue name="schema">EDA</paramValue>

      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_insertEntityGraph"/>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_updateOntologySynonym_ordinals"/>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_updateOntologySynonym_owlAttributes"/>
    </step>
    
    <step name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_loadEntityTypeAndAttributeGraphs" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertEDA" stepLoadTypes="plugin">
    	<paramValue name="plugin">ApiCommonData::Load::Plugin::LoadEntityTypeAndAttributeGraphs</paramValue>
      <paramValue name="extDbRlsSpec">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC|${version}</paramValue>
      <paramValue name="webDisplayOntologyName">${webDisplayOntologyName}</paramValue>
    	<paramValue name="schema">EDA</paramValue>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_loadAttributesFromEntityGraph"/>
    </step>
    
    <step name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_loadDatasetSpecificEntityGraph" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertEDA" stepLoadTypes="plugin">
    	<paramValue name="plugin">ApiCommonData::Load::Plugin::LoadDatasetSpecificEntityGraph</paramValue>
    	<paramValue name="schema">EDA</paramValue>
      <paramValue name="extDbRlsSpec">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC|${version}</paramValue>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_loadEntityTypeAndAttributeGraphs"/>
    </step>

<!-- deprecated in EDA
    <step name="${subProjectName}_${groupName}_${studyName}_RSRC_tuning"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeDatasetSpecificDerivedTables" stepLoadTypes="tuningManager">
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="tables">SampleId,PANRecord,PANResults,PANIO,PANExtDbRls,InferredParams,PANParamValues,DefaultChars,Metadata,MetadataSummary,Ontology,Samples,PropertyType,PropertyCategory,ComComObsIO,ComHouseIO,ComPartIO,ComObsIO,ComSampleIO,CommunityMD,CommunityObsMD,HousePartIO,HouseObsIO,PartObsIO,PartSampleIO,HouseSampleIO,ObsSampleIO,ObsObsIO,HouseEntoIO,EntoInsSplIO,ParticipantMD,ObservationMD,HouseholdMD,EntomologyMD,SampleMD,RecordCount</paramValue>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC"/>
      <depends name="OntologyTerm_${webDisplayOntologyName}_RSRC"/>
    </step>
--> 
    <step name="${subProjectName}_${groupName}_${studyName}_RSRC_studyCharacteristics"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertStudyCharacteristics">
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="file">$PROJECT_HOME/ClinEpiPresenters/Model/lib/yaml/ClinEpiDB.yaml</paramValue>
      <paramValue name="owlFile">$GUS_HOME/ontology/release/production/classifications.owl</paramValue>
      <paramValue name="commit">1</paramValue>
      <paramValue name="schema">EDA</paramValue>
      <depends name="OntologyTerm_classifications_RSRC"/>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_insertEntityGraph"/>
    </step>

    <step name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_makeEntityDownloadFiles" 
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertEDA">
    	<paramValue name="plugin">ApiCommonData::Load::Plugin::MakeEntityDownloadFiles</paramValue>
      <paramValue name="extDbRlsSpec">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC|${version}</paramValue>
      <paramValue name="fileBasename">${groupName}_${studyName}</paramValue>
      <paramValue name="webDisplayOntologyName">${webDisplayOntologyName}</paramValue>
      <paramValue name="dataDir">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="outputDir"></paramValue>
    	<paramValue name="schema">EDA</paramValue>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_loadDatasetSpecificEntityGraph"/>
    </step>

    <step name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_copyEntityDownloadFiles" 
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyShinyFilesToDownloadDir">
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue> 
      <paramValue name="nameForFilenames">${nameForFilenames}</paramValue>
      <paramValue name="inputFileBaseName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="relativeDownloadSiteDir">$$relativeDownloadSiteDir$$</paramValue>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_makeEntityDownloadFiles"/>
      <depends name="makeProjectReleaseDownloadDir"/>
    </step>

    <step name="${subProjectName}_${groupName}_${studyName}_RSRC_manualDownloadFiles"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyDownloadFilesDirFromManualDelivery">
      <paramValue name="projectName">${projectName}</paramValue>
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="relativeManualDeliveryDir">${subProjectName}/${groupName}/${studyName}/${version}/final/downloadSiteFiles</paramValue>
      <paramValue name="relativeDownloadSiteDir">$$relativeDownloadSiteDir$$</paramValue>
      <depends name="makeProjectReleaseDownloadDir"/>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC"/>
    </step>

  </datasetTemplate>

  <datasetTemplate class="ISASimpleClinEpiPreview">
    <prop name="projectName"/>
    <prop name="subProjectName"/>
    <prop name="groupName"/>
    <prop name="studyName"/>
    <prop name="version"/>
    <prop name="nameForFilenames"/>
    
    <subgraph name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="version">${version}</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir"></paramValue>
<!--
      <dependsGlobal name="EuPath_Ontology_RSRC"/>
-->
    </subgraph>

    <step name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_loadPreviewStudy" 
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertEDA">
    	<paramValue name="plugin">ApiCommonData::Load::Plugin::InsertEntityStudy</paramValue>
      <paramValue name="extDbRlsSpec">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC|${version}</paramValue>
      <paramValue name="stableId">PREVIEW_${subProjectName}_${groupName}_${studyName}</paramValue>
      <paramValue name="commit">1</paramValue>
    	<paramValue name="schema">EDA</paramValue>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC"/>
    </step>

    <step name="${subProjectName}_${groupName}_${studyName}_RSRC_studyCharacteristics"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertStudyCharacteristics">
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="file">$PROJECT_HOME/ClinEpiPresenters/Model/lib/yaml/ClinEpiDB.yaml</paramValue>
      <paramValue name="owlFile">$GUS_HOME/ontology/release/production/classifications.owl</paramValue>
      <paramValue name="commit">1</paramValue>
      <paramValue name="schema">EDA</paramValue>
      <depends name="OntologyTerm_classifications_RSRC"/>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_loadPreviewStudy"/>
    </step>

<!-- deprecated in EDA
    <step name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC_insertStudy" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertStudy" stepLoadTypes="plugin">
      <paramValue name="experimentName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="experimentExtDbRlsSpec">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC|${version}</paramValue>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC"/>
    </step>
    <step name="${subProjectName}_${groupName}_${studyName}_RSRC_tuning"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeDatasetSpecificDerivedTables" stepLoadTypes="tuningManager">
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="file">$GUS_HOME/ontology/General/study_classifications/ini</paramValue>
      <paramValue name="owlFile">$GUS_HOME/ontology/release/production/classifications.owl</paramValue>
      <paramValue name="commit">1</paramValue>
      <depends name="OntologyTerm_classifications_RSRC"/>
      <depends name="ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC"/>
    </step>
--> 

    <step name="${subProjectName}_${groupName}_${studyName}_RSRC_manualDownloadFiles"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyDownloadFilesDirFromManualDelivery">
      <paramValue name="projectName">${projectName}</paramValue>
      <paramValue name="datasetName">ISASimple_${subProjectName}_${groupName}_${studyName}_RSRC</paramValue>
      <paramValue name="relativeManualDeliveryDir">${subProjectName}/${groupName}/${studyName}/${version}/final/downloadSiteFiles</paramValue>
      <paramValue name="relativeDownloadSiteDir">$$relativeDownloadSiteDir$$</paramValue>
      <depends name="makeProjectReleaseDownloadDir"/>
    </step>
  </datasetTemplate>

</workflowGraph>
